from abc import ABC, abstractmethod
import os

class Kniga:
    def __init__(self, nazvanie, avtor, vzyta="Нет"):
        self.nazvanie = nazvanie
        self.avtor = avtor
        self.vzyta = vzyta

    def poluchit_info(self):
        status = "Доступна"
        if self.vzyta == "Да":
            status = "Выдана"
        return f"Книга: {self.nazvanie}, Автор: {self.avtor}, Статус: {status}"

class Chelovek(ABC):
    def __init__(self, imya):
        self.__imya = imya

    def poluchit_imya(self):
        return self.__imya

    @abstractmethod
    def pokazat_menu(self):
        pass

class Bibliotekar(Chelovek):
    def __init__(self, imya):
        super().__init__(imya)

    def pokazat_menu(self):
        print("\n--- Меню Библиотекаря ---")
        print("1. Добавить новую книгу")
        print("2. Удалить книгу")
        print("3. Зарегистрировать пользователя")
        print("4. Просмотреть список всех пользователей")
        print("5. Просмотреть список всех книг")
        print("0. Выход в главное меню")

    def dobavit_knigu(self, spisok_knig):
        while True:
            try:
                nazv = input("Введите название книги: ")
                avt = input("Введите автора: ")
                if nazv and avt:
                    novaya = Kniga(nazv, avt)
                    spisok_knig.append(novaya)
                    print("Книга успешно добавлена!")
                    break
                else:
                    print("Название и автор не могут быть пустыми!")
            except Exception as e:
                print(f"Ошибка при добавлении: {e}")

    def udalit_knigu(self, spisok_knig):
        while True:
            try:
                nazv = input("Введите название книги для удаления: ")
                nashel = False
                for k in spisok_knig:
                    if k.nazvanie == nazv:
                        spisok_knig.remove(k)
                        nashel = True
                        print("Книга удалена из системы.")
                        break
                if not nashel:
                    print("Такая книга не найдена.")
                break
            except Exception as e:
                print(f"Ошибка при удалении: {e}")

    def reg_polzovatelya(self, spisok_polzovateley):
        while True:
            try:
                im = input("Введите имя нового пользователя: ")
                if im:
                    noviy_user = Polzovatel(im)
                    spisok_polzovateley.append(noviy_user)
                    print("Пользователь успешно зарегистрирован.")
                    break
                else:
                    print("Имя не может быть пустым.")
            except Exception as e:
                print(f"Ошибка регистрации: {e}")

    def pokazat_vseh_userov(self, spisok_polzovateley):
        print("\nСписок всех пользователей:")
        if not spisok_polzovateley:
            print("Пользователей пока нет.")
        for u in spisok_polzovateley:
            print(f"- {u.poluchit_imya()}")

    def pokazat_vse_knigi(self, spisok_knig):
        print("\nСписок всех книг:")
        if not spisok_knig:
            print("В библиотеке нет книг.")
        for k in spisok_knig:
            print(k.poluchit_info())

class Polzovatel(Chelovek):
    def __init__(self, imya):
        super().__init__(imya)
        self.moi_knigi = []

    def pokazat_menu(self):
        print("\n--- Меню Пользователя ---")
        print("1. Просмотреть доступные книги")
        print("2. Взять книгу")
        print("3. Вернуть книгу")
        print("4. Просмотреть мои книги")
        print("0. Выход в главное меню")

    def pokazat_dostupnye(self, spisok_knig):
        print("\nДоступные книги:")
        schet = 0
        for k in spisok_knig:
            if k.vzyta == "Нет":
                print(k.poluchit_info())
                schet += 1
        if schet == 0:
            print("Сейчас нет свободных книг.")

    def vzyat_knigu(self, spisok_knig):
        while True:
            try:
                nazv = input("Введите название книги, которую хотите взять: ")
                nashel = False
                for k in spisok_knig:
                    if k.nazvanie == nazv:
                        nashel = True
                        if k.vzyta == "Да":
                            print("Извините, эта книга уже выдана.")
                        else:
                            k.vzyta = "Да"
                            self.moi_knigi.append(k.nazvanie)
                            print(f"Вы успешно взяли книгу '{k.nazvanie}'.")
                        break
                if not nashel:
                    print("Такой книги нет в нашей библиотеке.")
                break
            except Exception as e:
                print(f"Ошибка: {e}")

    def vernut_knigu(self, spisok_knig):
        while True:
            try:
                nazv = input("Введите название книги для возврата: ")
                if nazv in self.moi_knigi:
                    self.moi_knigi.remove(nazv)
                    for k in spisok_knig:
                        if k.nazvanie == nazv:
                            k.vzyta = "Нет"
                            break
                    print("Вы вернули книгу. Спасибо!")
                else:
                    print("У вас нет такой книги в списке взятых.")
                break
            except Exception as e:
                print(f"Ошибка: {e}")

    def pokazat_moi(self):
        print("\nСписок ваших книг:")
        if not self.moi_knigi:
            print("Вы еще не брали книг.")
        else:
            for nazv in self.moi_knigi:
                print(f"- {nazv}")

def zagruzit_dannye():
    knigi = []
    yuzeri = []
    if not os.path.exists("knigi.txt"):
        open("knigi.txt", "w").close()
    if not os.path.exists("polzovateli.txt"):
        open("polzovateli.txt", "w").close()

    try:
        with open("knigi.txt", "r", encoding="utf-8") as f:
            for stroka in f:
                chasti = stroka.strip().split(",")
                if len(chasti) >= 3:
                    knigi.append(Kniga(chasti[0], chasti[1], chasti[2]))
    except Exception as e:
        print(f"Ошибка при чтении книг: {e}")

    try:
        with open("polzovateli.txt", "r", encoding="utf-8") as f:
            for stroka in f:
                chasti = stroka.strip().split(",")
                if len(chasti) >= 1:
                    u = Polzovatel(chasti[0])
                    if len(chasti) > 1:
                        for i in range(1, len(chasti)):
                            if chasti[i]:
                                u.moi_knigi.append(chasti[i])
                    yuzeri.append(u)
    except Exception as e:
        print(f"Ошибка при чтении пользователей: {e}")
    return knigi, yuzeri

def sohranit_dannye(knigi, yuzeri):
    try:
        with open("knigi.txt", "w", encoding="utf-8") as f:
            for k in knigi:
                f.write(f"{k.nazvanie},{k.avtor},{k.vzyta}\n")
        with open("polzovateli.txt", "w", encoding="utf-8") as f:
            for u in yuzeri:
                stroka = u.poluchit_imya()
                for mk in u.moi_knigi:
                    stroka += "," + mk
                f.write(stroka + "\n")
    except Exception as e:
        print(f"Критическая ошибка сохранения: {e}")

def main():
    spisok_knig, spisok_yuzerov = zagruzit_dannye()
    print("Добро пожаловать в систему управления библиотекой!")

    while True:
        try:
            print("\n--- Главное Меню ---")
            rol = input("Выберите роль (1 - Библиотекарь, 2 - Пользователь, 0 - Выход): ")
            
            if rol == "0":
                sohranit_dannye(spisok_knig, spisok_yuzerov)
                print("Все данные сохранены. Программа завершена.")
                break
            
            elif rol == "1":
                imya_admina = input("Введите ваше имя: ")
                admin = Bibliotekar(imya_admina)
                while True:
                    admin.pokazat_menu()
                    vybor = input("Ваш выбор: ")
                    if vybor == "1":
                        admin.dobavit_knigu(spisok_knig)
                    elif vybor == "2":
                        admin.udalit_knigu(spisok_knig)
                    elif vybor == "3":
                        admin.reg_polzovatelya(spisok_yuzerov)
                    elif vybor == "4":
                        admin.pokazat_vseh_userov(spisok_yuzerov)
                    elif vybor == "5":
                        admin.pokazat_vse_knigi(spisok_knig)
                    elif vybor == "0":
                        break
                    else:
                        print("Некорректный ввод, попробуйте снова.")
                    sohranit_dannye(spisok_knig, spisok_yuzerov)

            elif rol == "2":
                imya_usera = input("Введите ваше имя для входа: ")
                tekushiy_polzovatel = None
                for u in spisok_yuzerov:
                    if u.poluchit_imya() == imya_usera:
                        tekushiy_polzovatel = u
                        break
                
                if tekushiy_polzovatel is None:
                    print("Такой пользователь не зарегистрирован в системе!")
                else:
                    while True:
                        tekushiy_polzovatel.pokazat_menu()
                        vybor = input("Ваш выбор: ")
                        if vybor == "1":
                            tekushiy_polzovatel.pokazat_dostupnye(spisok_knig)
                        elif vybor == "2":
                            tekushiy_polzovatel.vzyat_knigu(spisok_knig)
                        elif vybor == "3":
                            tekushiy_polzovatel.vernut_knigu(spisok_knig)
                        elif vybor == "4":
                            tekushiy_polzovatel.pokazat_moi()
                        elif vybor == "0":
                            break
                        else:
                            print("Некорректный ввод.")
                        sohranit_dannye(spisok_knig, spisok_yuzerov)
            else:
                print("Ошибка выбора роли.")
        except Exception as e:
            print(f"Произошла ошибка в работе программы: {e}")

